<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Studio - Doc Javelin</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/editor.css' %}">
    <!-- RemixIcon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
         :root {
            /* Inherit Theme from Base */
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #60a5fa;
            --secondary: #10b981;
            --dark: #111827;
            --gray: #6b7280;
            --light-gray: #f8fafc;
            --border: #e2e8f0;
            --danger: #ef4444;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <header class="editor-top-bar">
        <div class="top-left">
            <a href="/" class="back-home">‚Üê</a>
            <div class="file-info">
                <span class="tool-name" id="toolNameDisplay">{{ tool|title }}</span>
                <span class="separator">/</span>
                <span class="file-name" id="fileNameDisplay">{% if initial_files %}{{ initial_files.0.name }}{% else %}No File{% endif %}</span>
            </div>
        </div>
        
        <div class="top-center">
            <button class="tool-btn" id="zoomOutBtn" title="Zoom Out">‚ûñ</button>
            <span id="zoomLevelDisplay" style="font-size: 0.8rem; color: var(--gray); margin: 0 8px; min-width: 40px; text-align: center;">100%</span>
            <button class="tool-btn" id="zoomInBtn" title="Zoom In">‚ûï</button>
            <span style="border-right: 1px solid var(--border); margin: 0 12px; height: 20px;"></span>
            <button class="tool-btn" id="undoBtn" title="Undo">‚Ü©</button>
            <button class="tool-btn" id="redoBtn" title="Redo">‚Ü™</button>
        </div>
        
        <div class="top-right">
            <button class="btn-text" id="resetBtn">Reset</button>
            <button class="btn-close" onclick="window.location.href='/'">Exit</button>
        </div>
    </header>

    <div class="editor-workspace">
        <!-- Left Toolbar (Dynamic) -->
        <aside class="editor-left-panel" id="leftPanel">
            <!-- Icons injected by tools.js -->
        </aside>

        <!-- Main Canvas -->
        <main class="editor-canvas" id="mainCanvas">
             <div class="canvas-loader" id="canvasLoader" style="display:none;">Loading...</div>
             <div id="canvasContent" class="canvas-content">
                 <!-- Preview or Grid goes here -->
                 <div class="placeholder-msg" id="uploadContainer">
                     {% if initial_files %}
                        <iframe src="{{ initial_files.0.url }}#toolbar=0" class="pdf-viewer-frame"></iframe>
                     {% else %}
                        <div class="upload-box" id="dropZone">
                            <div class="upload-icon">üìÑ</div>
                            <h2>Select PDF files</h2>
                            <p>or drag and drop them here</p>
                            <input type="file" id="fileInput" multiple style="display:none">
                            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">Select Files</button>
                        </div>
                     {% endif %}
                 </div>
             </div>
        </main>

        <!-- Right Settings Panel (Dynamic) -->
        <aside class="editor-right-panel" id="rightPanel">
            <div class="panel-header">Settings</div>
            <div id="toolSettings" class="settings-content">
                <!-- Controls injected by tools.js -->
            </div>
        </aside>
    </div>

    <!-- Bottom Bar -->
    <footer class="editor-bottom-bar">
        <div class="bottom-left">
            <!-- Status messages -->
            <span id="statusText">Ready</span>
        </div>
        <div class="bottom-right">
            <button class="btn-secondary" id="saveDraftBtn">Save Draft</button>
            <button class="btn-primary" id="processBtn">Process & Download</button>
        </div>
    </footer>

    <!-- Preview Modal -->
    <div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; width: 90%; height: 90%; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; position: relative;">
            <div style="padding: 16px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                <h3 style="margin: 0; color: var(--dark);">Document Preview</h3>
                <button onclick="closePreview()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">&times;</button>
            </div>
            <iframe id="preview-frame" style="flex: 1; border: none; width: 100%; height: 100%;" src=""></iframe>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signature-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Add Signature</h3>
                <button onclick="closeSignatureModal()" class="btn-close" style="font-size: 1.5rem;">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="modal-tabs">
                    <div class="modal-tab active" onclick="switchSigTab('draw')">Draw</div>
                    <div class="modal-tab" onclick="switchSigTab('type')">Type</div>
                    <div class="modal-tab" onclick="switchSigTab('upload')">Upload</div>
                </div>
                
                <!-- Draw Tab -->
                <div id="sig-draw" class="tab-content active">
                    <div class="signature-pad-wrapper" id="sig-pad-container">
                        <!-- Canvas injected by JS -->
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <button class="btn-text" onclick="clearSignaturePad()">Clear</button>
                    </div>
                </div>
                
                <!-- Type Tab -->
                <div id="sig-type" class="tab-content">
                    <input type="text" id="sig-nav-input" class="signature-input" placeholder="Type your name" oninput="updateSigPreview(this.value)">
                    <div id="sig-type-preview" class="font-preview" style="font-family: 'Great Vibes', cursive;"></div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button class="btn-secondary" onclick="changeSigFont('Great Vibes')">Great Vibes</button>
                        <button class="btn-secondary" onclick="changeSigFont('Sacramento')">Sacramento</button>
                    </div>
                </div>
                
                <!-- Upload Tab -->
                <div id="sig-upload" class="tab-content">
                    <div class="upload-box" style="padding: 20px;">
                        <input type="file" id="sig-upload-input" accept="image/*" style="display: block; margin: 0 auto;">
                        <div id="sig-upload-preview" style="margin-top: 20px; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSignatureModal()">Cancel</button>
                <button class="btn-primary" onclick="addSignatureToCanvas()">Add Signature</button>
            </div>
        </div>
    </div>

    <!-- Initial Data for JS -->
    {{ initial_files|json_script:"initial-files-data" }}
    <script>
        window.EDITOR_CONFIG = {
            tool: "{{ tool }}",
            sessionId: "{{ session_id }}",
            files: JSON.parse(document.getElementById('initial-files-data').textContent),
            csrfToken: "{{ csrf_token }}"
        };
    </script>
    <script src="{% static 'js/tools.js' %}?v=2.0"></script>
    <script src="{% static 'js/editor.js' %}?v=2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="{% static 'js/fabric-overlay.js' %}?v=1.0"></script>
    <script src="{% static 'js/signature.js' %}?v=1.0"></script>
    <script src="{% static 'js/inspector.js' %}?v=1.0"></script>
    <!-- Fonts for Signatures -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Sacramento&display=swap" rel="stylesheet">
</body>
</html>
