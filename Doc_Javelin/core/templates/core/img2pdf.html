{% extends "core/base.html" %}

{% block title %}Image to PDF - Doc Javelin{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        padding: 60px 20px;
        text-align: center;
        color: white;
        margin-bottom: 40px;
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 12px;
    }

    .page-header p {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    .page-content {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px 60px;
    }

    .tips-card {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-left: 4px solid var(--primary);
    }

    .tips-card h3 {
        color: var(--primary);
        margin-bottom: 16px;
        font-size: 1.3rem;
        font-weight: 700;
    }

    .tips-card ul {
        list-style: none;
        padding: 0;
    }

    .tips-card li {
        padding: 8px 0;
        padding-left: 28px;
        position: relative;
        color: var(--dark);
        line-height: 1.7;
    }

    .tips-card li::before {
        content: '‚úì';
        position: absolute;
        left: 0;
        color: var(--success);
        font-weight: bold;
        font-size: 1.2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üñºÔ∏è Image to PDF</h1>
    <p>Convert your images to professional PDF documents instantly</p>
</div>

<div class="page-content">
    <div class="card">
        <p style="margin-bottom: 32px; font-size: 1.1rem;">Transform your images into PDF format. Supports JPG, PNG, GIF, BMP, TIFF, and WEBP formats. Convert single or multiple images at once.</p>
        
        <div class="file-upload" id="img2pdf-upload">
            <label for="img2pdf-files" class="file-upload-label">
                <span class="file-upload-icon">üìÅ</span>
                <span>Click to select images or drag and drop</span>
                <span style="font-size: 0.9rem; font-weight: 400; opacity: 0.7;">Supported: JPG, PNG, GIF, BMP, TIFF, WEBP</span>
            </label>
            <input type="file" id="img2pdf-files" multiple accept="image/*">
        </div>
        
        <div class="file-list" id="img2pdf-file-list"></div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="separate-pdfs">
            <label for="separate-pdfs">Create separate PDF file for each image</label>
        </div>
        
        <button class="btn" onclick="imgToPDF()">Convert to PDF</button>
        
        <div class="loading" id="img2pdf-loading">
            <div class="spinner"></div>
            <p>Converting images to PDF...</p>
        </div>
        
        <div class="message" id="img2pdf-message"></div>
    </div>

    <div class="card tips-card">
        <h3>üí° Pro Tips</h3>
        <ul>
            <li>Supported formats: JPG, JPEG, PNG, GIF, BMP, TIFF, WEBP</li>
            <li>You can convert multiple images at once for batch processing</li>
            <li>Check the box to create separate PDFs, or leave unchecked to combine all into one</li>
            <li>High-resolution images will maintain their quality in the PDF</li>
            <li>All uploaded files are automatically deleted after conversion for your security</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('img2pdf-upload');
    const fileInput = document.getElementById('img2pdf-files');

    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
    });

    uploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        displayFiles(files, 'img2pdf-file-list');
    }

    fileInput.addEventListener('change', function(e) {
        displayFiles(e.target.files, 'img2pdf-file-list');
    });

    uploadArea.addEventListener('click', () => fileInput.click());

    async function imgToPDF() {
        const files = fileInput.files;
        if (files.length === 0) {
            showMessage('img2pdf-message', 'Please select at least one image file', 'error');
            return;
        }

        const formData = new FormData();
        Array.from(files).forEach(file => {
            formData.append('files[]', file);
        });
        formData.append('separate', document.getElementById('separate-pdfs').checked);

        // Get CSRF Token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        showLoading('img2pdf-loading', true);
        hideMessage('img2pdf-message');
        document.querySelector('.btn').disabled = true;

        try {
            const response = await fetch("{% url 'img2pdf' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();
            showLoading('img2pdf-loading', false);
            document.querySelector('.btn').disabled = false;

            if (data.success && data.task_id) {
                window.location.href = `/result/${data.task_id}`;
            } else if (data.success) {
                let links = '';
                if (Array.isArray(data.files)) {
                    links = data.files.map(f => 
                        `<a href="/download/${f}" class="download-link">‚¨áÔ∏è Download ${f}</a>`
                    ).join(' ');
                } else {
                    const downloadUrl = data.url || `/download/${data.filename}`;
                    links = `<a href="${downloadUrl}" class="download-link">‚¨áÔ∏è Download PDF</a>`;
                }
                showMessage('img2pdf-message', 
                    `${data.message} | ${links}`, 
                    'success');
            } else {
                showMessage('img2pdf-message', data.error || 'Failed to convert images. Please try again.', 'error');
            }
        } catch (error) {
            showLoading('img2pdf-loading', false);
            document.querySelector('.btn').disabled = false;
            showMessage('img2pdf-message', 'Error: ' + error.message, 'error');
        }
    }

    function displayFiles(files, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        Array.from(files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileItem.innerHTML = `
                <span>üñºÔ∏è ${file.name} <span style="color: var(--gray); font-size: 0.9rem;">(${fileSize} MB)</span></span>
                <button onclick="removeFile(${index}, '${containerId}')">Remove</button>
            `;
            container.appendChild(fileItem);
        });
    }

    function removeFile(index, containerId) {
        const dt = new DataTransfer();
        
        Array.from(fileInput.files).forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });
        
        fileInput.files = dt.files;
        displayFiles(fileInput.files, containerId);
    }

    function showLoading(id, show) {
        document.getElementById(id).style.display = show ? 'block' : 'none';
    }

    function showMessage(id, message, type) {
        const msgEl = document.getElementById(id);
        msgEl.className = `message ${type}`;
        msgEl.innerHTML = message;
        msgEl.style.display = 'block';
    }

    function hideMessage(id) {
        document.getElementById(id).style.display = 'none';
    }
</script>
{% endblock %}
